---
title: El ataque a Tornado Cash y c贸mo desplegar diferentes contratos en la misma direcci贸n.
description:
  Muchos dias y algunas promesas han pasado desde la ultima publicaci贸n.
  Pero volvemos estudiando el ataque que sufri贸 Tornado Cash hace algunos dias,
  mientras aprendemos algunas cosas interesantes sobre Solidity y la EVM, como por ejemplo,
  desplegar dos contratos diferentes en la misma direcci贸n. Si quires saber como hacerlo, 隆vamos a verlo!
publishedAt: 2023/05/28
tags:
  - Solidity
  - Ethereum
  - EVM
  - Smart Contract
  - Seguridad
  - create2
  - delegatecall
---

## Tornado Cash

Tornado Cash es (o era) un protocolo financiero descentralizado (DeFi) que permit铆a a los usuarios realizar transacciones an贸nimas en Ethereum.
El protocolo de Tornado Cash consist铆a en un contrato llamado "mixer", usado para crear transacciones an贸nimas. El mixer deb铆a dividir el ETH depositado por un usuario
en partes m谩s peque帽as que luego eran mezcladas con los depositos de los dem谩s usuarios. Una vez finalizada la mezcla, el usuario pod铆a retirar sus Ethers anonimizados.

El protocolo tambien ten铆a una funci贸n llamada "shielding" que permit铆a a los usuarios convertir sus Ethers en una versi贸n privada llamada "zETH". Hablamos todo el
tiempo en pasado porque al parecer el protocolo ya no est谩 disponible para nadie. Su p谩gina web fue removida y todos sus repositorios de GitHub fueron archivados.

![Web de Tornado Cash](https://gateway.pinata.cloud/ipfs/QmVT5wxGZKHccJqkhWzim2iw3jvBUyRrwAXSLSttvxbMvz)

![GitHub de Tornado Cash](https://gateway.pinata.cloud/ipfs/QmYRKq4NvRq25Ku3x2aY2iZuL5MdHjfzwM8Ck9LEwWuQyX?_gl=1*14dascm*rs_ga*NDMwNTE0ODA1LjE2ODUzMTI5OTI.*rs_ga_5RMPXG14TE*MTY4NTMxMjk5Mi4xLjEuMTY4NTMxNDA2Ny4yLjAuMA..)

## El ataque

El pasado 20 de mayo [@samczsun.com](https://twitter.com/samczsun) publicaba noticias sobre el ataque a Tornado Cash.

![Tweet de @samczsun.com](https://gateway.pinata.cloud/ipfs/QmdiqvUhHpuZG24s4xsnt3y29ADdGvbMGCey64YL9JcrfQ?_gl=1*1d3jxs4*rs_ga*NDMwNTE0ODA1LjE2ODUzMTI5OTI.*rs_ga_5RMPXG14TE*MTY4NTMxMjk5Mi4xLjEuMTY4NTMxNDkzMy42MC4wLjA.)

El atacante obtuvo control total sobre la governanza de Tornado Cash, permitiendole:

- Retirar todos los votos bloqueados.
- Retirar todos los tokens de la governanza.
- Bloquear el Router.
- Vaciar los depositos de cada usuario.

### 驴C贸mo ocurrio todo?

Seg煤n [@samczsun.com](https://twitter.com/samczsun) cuando el atacante cre贸 su propuesta maliciosa, afirm贸 haber utilizado la misma l贸gica
que una propuesta anterior que hab铆a sido aprobada. Sin embargo, eso no era exactamente cierto, porque hab铆a una funci贸n adicional.

Una vez que la propuesta fue aprobada por los votantes, el atacante simplemente utiliz贸 la funci贸n `emergencyStop` para actualizar la l贸gica
de la propuesta y concederse a s铆 mismo los votos fraudulentos.

Ahora que el atacante ten铆a el poder sobre todos los votos, pod铆a hacer lo que quisiera. En este caso, simplemente retir贸 10.000 votos como TORN y los vendi贸 todos.

**[Link al hilo](https://twitter.com/samczsun/status/1660012956632104960?s=20)**

## _Diving into the hack_ 

### Creando nuevos contratos

#### CREATE

En Ethereum, tenemos dos formas de crear un contrato. La primera forma, y quiza las m谩s usada es atravez del _CREATE opcode_. De esta forma, la direcci贸n del
contrato estar谩 definida en funci贸n del _sender_ (la direcci贸n que ejecuta la creaci贸n) y el nonce de esa misma cuenta.

```javascript
new_address = hash(sender, nonce);
```

#### CREATE2

La otra forma es a travez del _CREATE2 opcode_. La diferencia con la primera forma es que a travez de este m茅todo, podemos predecir la direcci贸n en la que ser谩
desplegado el contrato, incluso si nunca lo hacemos.

La idea detr谩s de este _opcode_ es hacer que la direcci贸n resultante sea independiente de eventos futuros. Independientemente de lo que pueda ocurrir en la cadena,
siempre ser谩 posible desplegar el contrato en la direcci贸n precalculada.

En este caso, la forma de computar la direcci贸n del nuevo contrato es un poco diferente. Esta vez, la direcci贸n se define en funci贸n de:

- `0xFF`, una constante para prevenir colisiones con el _CREATE opcode_.
- La direcci贸n del _sender_.
- Un `salt` (un valor arbitrario proporcionado por el remitente en bytes).
- El bytecode del contrato a desplegar.

```javascript
new_address = hash(0xff, sender, salt, bytecode);
```

El _CREATE2 opcode_ garantiza que si en algun momento el _sender_ despliega el bytecode de un contrato utilizando _CREATE2_ y el mismo `salt`, entonces la
nueva direcci贸n siempre ser谩 `new_address`.

Dado que el bytecode se incluye en este c谩lculo, otros agentes pueden confiar en que, si alguna vez se despliega un contrato en `new_address`, ser谩 uno que
conozcan. Este es el concepto clave detr谩s de los despliegues [contrafactuales](https://es.wikipedia.org/wiki/Contrafactual).

**Mas detalles en: [Deploying Smart Contracts Using CREATE2](https://docs.openzeppelin.com/cli/2.8/deploying-with-create2)**

## 驴C贸mo se ve esto en Solidity?

S茅 que si llegaste hasta aqu铆 es porque quieres saber como se ve toda esta teor铆a en la practica. 隆Asi que vamos con eso!

El primer lugar el atacante deb铆a desplegar una `Proposal` que deb铆a ser revisada y aprovaba por la governanza de Tornado Cash.

![Env铆a la propuesta y es aceptada](https://gateway.pinata.cloud/ipfs/QmZmsXZUhxea2XfgfqWzkpr4tDkduSkxub4Dhh8kLTk5Yf?_gl=1*1pg9hhh*rs_ga*NDMwNTE0ODA1LjE2ODUzMTI5OTI.*rs_ga_5RMPXG14TE*MTY4NTMxNzY3NC4yLjAuMTY4NTMxNzY3NC42MC4wLjA.)

Luego, el atacante "elimin贸" el contrato en esa direcci贸n usando la funci贸n `selfdestruct`.

![Elimina el contrato](https://gateway.pinata.cloud/ipfs/QmcNpnkqibRgwKevCLz6aPtKKSXxJHNav2Uy7nh4oCfFqU?_gl=1*1rq9yv2*rs_ga*NDMwNTE0ODA1LjE2ODUzMTI5OTI.*rs_ga_5RMPXG14TE*MTY4NTMxNzY3NC4yLjEuMTY4NTMxODAyNy42MC4wLjA.)

Una vez eliminado el contrato de esa direcci贸n, el atacante pod铆a desplegar un nuevo contrato, en el que Tornado Cash confiar铆a, pero esta vez, con c贸digo malicioso que le permitir铆a
tomar el control del protocolo ejecutando la propuesta, pero con un resultado inesperado ゲ.

![Despliega el contrato malicioso en la misma direcci贸n](https://gateway.pinata.cloud/ipfs/QmdBJCPLwPCPtoL2D1X5NTa5SsBgdEsEAQa2ttTK1YkZMw?_gl=1*1k6j0wa*rs_ga*NDMwNTE0ODA1LjE2ODUzMTI5OTI.*rs_ga_5RMPXG14TE*MTY4NTMxNzY3NC4yLjEuMTY4NTMxODM4NC42MC4wLjA.)

### 驴C贸mo desplegar diferentes contratos en la misma direcci贸n?

Imaginemos que el atacante despliega un contrato llamado `DeployerDeployer` y que a travez del _CREATE2 opcode_ despliega un contrato llamado `Deployer` que a su vez, depliega
un contrato llamado `Proposal` que ser谩 enviado a la governanza de Tornado Cash para su revisi贸n y aprobaci贸n. Si este mismo contrato intentara desplegar un nuevo contrato
para suplantar el anterior no podr铆a hacerlo porque el `nonce` de su cuenta ya camb铆o, por lo tanto, la nueva direcci贸n ser谩 diferente a la anterior.

![Despliegue mediante CREATE](https://gateway.pinata.cloud/ipfs/QmSKcaDSmktBDcRzbA3yH5YxU5pYsbNws5K4LFCvdEyf96?_gl=1*avo7w3*rs_ga*NDMwNTE0ODA1LjE2ODUzMTI5OTI.*rs_ga_5RMPXG14TE*MTY4NTMxNzY3NC4yLjEuMTY4NTMxOTA0OC42MC4wLjA.)

Volvamos sobre la forma en la que se crean la direcciones en Ethereum. Cuando usamos el _CREATE opcode_ la direcci贸n ser谩:

```
address = ultimos 20 bytes de sha3(rlp(sender,nonce))
```

De forma que si el nonce camb铆a, la direcci贸n cambia. **Si existiera alguna forma de reiniciar el valor del _nonce_ podr铆amos desplegar otro contrato en la misma direcci贸n.** Y existe una forma, 隆veamos c贸mo!

Imaginemos el mismo proceso que antes, pero esta vez con una diferencia. Antes de crear el contrato malicioso, el atacante "borra" el contrato `Deployer` a travez de la funci贸n `selfdestruct`.
Ahora, el atacante puede volver a desplegar un contrato en la direcci贸n que antes ocupaba el contrato eliminado porque lo hizo utilizando el _CREATE2 opcode_. Este nuevo contrato, tendr谩
nuevamente un _nonce_ con su valor inicial: 0. Cuando el atacante despliegue un nuevo contrato a travez de este nuevo `Deployer`, estar谩 en la misma direcci贸n del `Proposal` que fue "borrado" anteriomente.

De esta forma, el atacante ahora puede ejecutar cualquier c贸digo que desee cuando Tornado Cash ejecute la propuesta porque el protocolo conf铆a en que el c贸digo en esa direcci贸n no ha cambiado .

![Despligue, eliminaci贸n, redespliegue](https://gateway.pinata.cloud/ipfs/QmSWSGttHA784F6ognepAMfcwqtQJMRTbNnQjwuPnX3etC?_gl=1*1li2aij*rs_ga*NDMwNTE0ODA1LjE2ODUzMTI5OTI.*rs_ga_5RMPXG14TE*MTY4NTMxNzY3NC4yLjEuMTY4NTMxOTkzOS42MC4wLjA.)

<aside>
  Si quieres saber como se ver铆a esto en Solidity, te invito a la sesi贸n del
  pr贸ximo s谩bado 3 de junio de 2023 en [dotlabs()](https://dotlabs.academy),
  donde replicaremos este ataque para conocerlo a profundidad.
</aside>
